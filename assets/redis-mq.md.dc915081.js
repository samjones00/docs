import{_ as a}from"./chunks/servicestack-mqclients.e7cc67b5.js";import{_ as e,c as t,o as p,a as n,b as s}from"./app.6a524bd5.js";const b='{"title":"Redis MQ","description":"","frontmatter":{"slug":"redis-mq","title":"Redis MQ"},"headers":[{"level":2,"title":"MQ Examples","slug":"mq-examples"},{"level":3,"title":"The SMessage Service","slug":"the-smessage-service"},{"level":2,"title":"Redis MQ Client / Server","slug":"redis-mq-client-server"},{"level":2,"title":"MQ Architecture in ServiceStack","slug":"mq-architecture-in-servicestack"},{"level":3,"title":"Easily testable and swappable","slug":"easily-testable-and-swappable"},{"level":2,"title":"Re-use your existing Web Services!","slug":"re-use-your-existing-web-services"},{"level":2,"title":"Example","slug":"example"},{"level":2,"title":"Redis","slug":"redis"},{"level":3,"title":"RedisMQ Client","slug":"redismq-client"},{"level":3,"title":"Request + Reply MQ Pattern","slug":"request-reply-mq-pattern"}],"relativePath":"redis-mq.md"}',o={},c=n(`<h2 id="mq-examples" tabindex="-1">MQ Examples <a class="header-anchor" href="#mq-examples" aria-hidden="true">#</a></h2><p>The <a href="https://github.com/ServiceStack/ServiceStack.UseCases/tree/master/Reusability" target="_blank" rel="noopener noreferrer">Reusability ServiceStack.UseCase</a> contains a good introductory demo of using MQ&#39;s(message-queues) in ServiceStack where the same services can be called via Web Service or via MQ. Using MQ&#39;s provide instant response times, in addition to reliable and durable execution of your services.</p><h3 id="the-smessage-service" tabindex="-1">The SMessage Service <a class="header-anchor" href="#the-smessage-service" aria-hidden="true">#</a></h3><p>The <a href="https://github.com/ServiceStack/ServiceStack.UseCases/blob/master/Reusability/SMessageService.cs#L63" target="_blank" rel="noopener noreferrer">SMessage Service</a> shows an example of dividing a service into multiple subtasks and dispatching them for instant response times and parallel processing of blocking operations without needing any multi-threading code in your application logic, e.g:</p><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">object</span></span> <span class="token function">Any</span><span class="token punctuation">(</span><span class="token class-name">SMessage</span> request<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> sw <span class="token operator">=</span> Stopwatch<span class="token punctuation">.</span><span class="token function">StartNew</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>request<span class="token punctuation">.</span>Defer<span class="token punctuation">)</span> <span class="token comment">//Process sequentially or Defer execution</span>
    <span class="token punctuation">{</span>
        <span class="token comment">//Executes service sequentially: N+1 service calls, times out if N too big</span>
        <span class="token class-name"><span class="token keyword">var</span></span> results <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>SMessageReceipt<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        results<span class="token punctuation">.</span><span class="token function">AddRange</span><span class="token punctuation">(</span>Email<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        results<span class="token punctuation">.</span><span class="token function">AddRange</span><span class="token punctuation">(</span>FacebookR<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        results<span class="token punctuation">.</span><span class="token function">AddRange</span><span class="token punctuation">(</span>Twitter<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Db<span class="token punctuation">.</span><span class="token function">InsertAll</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        <span class="token comment">//Split in smaller tasks and defers messages in MQ broker for parallel processing</span>
        Email<span class="token punctuation">.</span><span class="token function">CreateMessages</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ForEach</span><span class="token punctuation">(</span>MessageProducer<span class="token punctuation">.</span>Publish<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Facebook<span class="token punctuation">.</span><span class="token function">CreateMessages</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ForEach</span><span class="token punctuation">(</span>MessageProducer<span class="token punctuation">.</span>Publish<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Twitter<span class="token punctuation">.</span><span class="token function">CreateMessages</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ForEach</span><span class="token punctuation">(</span>MessageProducer<span class="token punctuation">.</span>Publish<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SMessageResponse</span> <span class="token punctuation">{</span>
        TimeTakenMs <span class="token operator">=</span> sw<span class="token punctuation">.</span>ElapsedMilliseconds<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="process-each-service-concurrently-without-holding-up-the-processing-of-other-tasks" tabindex="-1">Process each service concurrently without holding up the processing of other tasks <a class="header-anchor" href="#process-each-service-concurrently-without-holding-up-the-processing-of-other-tasks" aria-hidden="true">#</a></h4><p>Another benefit of dispatching messages into multiple sub tasks is if the Email API is slow, it doesn&#39;t hold up the processing of the other tasks which are all running concurrently in the background each individually processing messages as fast as they can.</p><h4 id="easily-parallelize-and-multiply-your-services-throughput" tabindex="-1">Easily Parallelize and Multiply your services throughput <a class="header-anchor" href="#easily-parallelize-and-multiply-your-services-throughput" aria-hidden="true">#</a></h4><p>The RedisMqServer also supports spawning any number of background threads for individual requests, so if Posting to twitter was an IO intensive operation you can double the throughput by simply assigning 2 or more worker threads, e.g:</p><div class="language-csharp"><pre><code>mqService<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">RegisterHandler</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>PostStatusTwitter<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>ExecuteMessage<span class="token punctuation">,</span> <span class="token named-parameter punctuation">noOfThreads</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
mqService<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">RegisterHandler</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>CallFacebook<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>ExecuteMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
mqService<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">RegisterHandler</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>EmailMessage<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>ExecuteMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="redis-mq-client-server" tabindex="-1">Redis MQ Client / Server <a class="header-anchor" href="#redis-mq-client-server" aria-hidden="true">#</a></h2><p>A redis-based message queue client/server that can be hosted in any .NET or <a href="http://ASP.NET" target="_blank" rel="noopener noreferrer">ASP.NET</a> application. All Redis MQ Hosts lives in the <a href="https://github.com/ServiceStack/ServiceStack/tree/master/src/ServiceStack.Server/Messaging/Redis" target="_blank" rel="noopener noreferrer">ServiceStack.Server</a> project and brings the many benefits of using a Message Queue.</p>`,12),l=s("div",{class:"nuget-copy cp flex cursor-pointer mb-3",onclick:"copy(this)"},[s("div",{class:"flex-grow bg-gray-700"},[s("div",{class:"pl-4 py-1 pb-1.5 align-middle text-lg text-white"},[s("p",null,[s("code",null,'<PackageReference Include="ServiceStack.Server" Version="6.*" />')])])]),s("div",{class:"flex"},[s("div",{class:"bg-sky-500 text-white p-1.5 pb-0"},[s("svg",{class:"copied w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M5 13l4 4L19 7"})]),s("svg",{class:"nocopy w-6 h-6",title:"copy",fill:"none",stroke:"white",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"1",d:"M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2"})])])])],-1),i=n('<h4 id="redismqserver" tabindex="-1"><a href="https://github.com/ServiceStack/ServiceStack/tree/master/src/ServiceStack.Server/Messaging/Redis/RedisMqServer.cs" target="_blank" rel="noopener noreferrer">RedisMqServer</a> <a class="header-anchor" href="#redismqserver" aria-hidden="true">#</a></h4><p>Works by using a background thread for <strong>each service</strong>. This allows you to process messages from different services concurrently. Recommended if you have any long-running services so other services can still run in parallel.</p><p>Major kudos goes to Redis which thanks to its versatility, has Pub/Sub and Lists primitives that makes implementing a Queue trivial.</p><h2 id="mq-architecture-in-servicestack" tabindex="-1">MQ Architecture in ServiceStack <a class="header-anchor" href="#mq-architecture-in-servicestack" aria-hidden="true">#</a></h2><p>The logical architecture of how a MQ Publisher and MQ Host works together in ServiceStack:</p><p><img src="'+a+`" alt=""></p><h3 id="easily-testable-and-swappable" tabindex="-1">Easily testable and swappable <a class="header-anchor" href="#easily-testable-and-swappable" aria-hidden="true">#</a></h3><p>All MQ implementations share the same <a href="https://github.com/ServiceStack/ServiceStack/blob/master/src/ServiceStack.Interfaces/Messaging/IMessageService.cs" target="_blank" rel="noopener noreferrer">IMessageService</a> so they&#39;re easily swappable and testable. There is also an <a href="https://github.com/ServiceStack/ServiceStack/blob/master/src/ServiceStack/Messaging/InMemoryTransientMessageService.cs" target="_blank" rel="noopener noreferrer">InMemoryTransientMessageService</a> available, useful for development &amp; testing.</p><p>These versions already sports the major features you&#39;ve come to expect from a MQ:</p><ul><li>Each service maintains its own Standard and Priority MQ&#39;s</li><li>Automatic Retries on messages generating errors with Failed messages sent to a DLQ (Dead Letter Queue) when its Retry threshold is reached.</li><li>Each message can have a ReplyTo pointing to any Queue, alternatively you can even provide a <strong>ServiceStack endpoint URL</strong> which will send the response to a Web Service instead. If the web service is not available it falls back into publishing it in the default Response Queue so you never lose a message! MQ/Web Services that don&#39;t return any output have their Request DTOs sent to a rolling Out queue which can be monitored by external services (i.e. the publisher/callee) to determine when the request has been processed.</li></ul><h2 id="re-use-your-existing-web-services" tabindex="-1">Re-use your existing Web Services! <a class="header-anchor" href="#re-use-your-existing-web-services" aria-hidden="true">#</a></h2><p>Although you can host RedisMqServer in any <a href="http://ASP.NET" target="_blank" rel="noopener noreferrer">ASP.NET</a> web app, the benefit of hosting inside ServiceStack is that your web services are <strong>already capable</strong> of processing Redis MQ messages <strong>without any changes required</strong> since they&#39;re already effectively designed to work like a Message service to begin with, i.e. C# POCO-in -&gt; C# POCO-out.</p><p>This is another example of how ServiceStack&#39;s prescribed DTO-first architecture continues to pay dividends since each web service is a DI clean-room allowing your C# logic to be kept pure as it only has to deal with untainted POCO DTOs, allowing your same web service to be re-used in: SOAP, REST (JSON,XML,JSV,CSV,HTML) web services, view models for dynamic HTML pages and now as a MQ service!</p><h2 id="example" tabindex="-1">Example <a class="header-anchor" href="#example" aria-hidden="true">#</a></h2><p>Hooking up a basic send/reply example is as easy as:</p><div class="language-csharp"><pre><code><span class="token comment">//DTO messages:</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Hello</span> <span class="token punctuation">{</span> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Name <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloResponse</span> <span class="token punctuation">{</span> <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Result <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>

<span class="token class-name"><span class="token keyword">var</span></span> redisFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">PooledRedisClientManager</span><span class="token punctuation">(</span><span class="token string">&quot;localhost:6379&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name"><span class="token keyword">var</span></span> mqHost <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">RedisMqServer</span><span class="token punctuation">(</span>redisFactory<span class="token punctuation">,</span> <span class="token named-parameter punctuation">retryCount</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//Server - MQ Service Impl:</span>
mqHost<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">RegisterHandler</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Hello<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>m <span class="token operator">=&gt;</span>
    <span class="token keyword">new</span> <span class="token constructor-invocation class-name">HelloResponse</span> <span class="token punctuation">{</span> Result <span class="token operator">=</span> <span class="token string">&quot;Hello, &quot;</span> <span class="token operator">+</span> m<span class="token punctuation">.</span><span class="token function">GetBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Name <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
mqHost<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token range operator">..</span><span class="token punctuation">.</span>

<span class="token comment">//Client - Process Response:</span>
mqHost<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">RegisterHandler</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>HelloResponse<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>m <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;Received: &quot;</span> <span class="token operator">+</span> m<span class="token punctuation">.</span><span class="token function">GetBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
mqHost<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token range operator">..</span><span class="token punctuation">.</span>

<span class="token comment">//Producer - Start publishing messages:</span>
<span class="token class-name"><span class="token keyword">var</span></span> mqClient <span class="token operator">=</span> mqHost<span class="token punctuation">.</span><span class="token function">CreateMessageQueueClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
mqClient<span class="token punctuation">.</span><span class="token function">Publish</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Hello</span> <span class="token punctuation">{</span> Name <span class="token operator">=</span> <span class="token string">&quot;ServiceStack&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><h2 id="redis" tabindex="-1">Redis <a class="header-anchor" href="#redis" aria-hidden="true">#</a></h2><div class="info custom-block"><p class="custom-block-title">INFO</p><p>This is a quote of a <a href="https://groups.google.com/d/msg/servicestack/Jl1xjlLH-4E/kz8mL_bq9zMJ" target="_blank" rel="noopener noreferrer">google group topic</a> to provide more information about ServiceStack and Redis until more documentation/examples are added</p></div><p>Redis is a NoSQL datastore that runs as a network server. To start it you need to run an instance of redis-server either locally or remotely accessible.</p><p>Probably will help to understand the background concepts behind Redis so you can get a better idea of how it works. This StackOverflow answer has a <a href="http://stackoverflow.com/a/2760282/85785" target="_blank" rel="noopener noreferrer">good overview about Redis in .NET</a>.</p><p>The <code>RedisMqServer</code> is in <a href="https://www.nuget.org/packages/ServiceStack.Server" target="_blank" rel="noopener noreferrer">ServiceStack.Server</a> project and can be installed with:</p>`,21),u=s("div",{class:"nuget-copy cp flex cursor-pointer mb-3",onclick:"copy(this)"},[s("div",{class:"flex-grow bg-gray-700"},[s("div",{class:"pl-4 py-1 pb-1.5 align-middle text-lg text-white"},[s("p",null,[s("code",null,'<PackageReference Include="ServiceStack.Server" Version="6.*" />')])])]),s("div",{class:"flex"},[s("div",{class:"bg-sky-500 text-white p-1.5 pb-0"},[s("svg",{class:"copied w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M5 13l4 4L19 7"})]),s("svg",{class:"nocopy w-6 h-6",title:"copy",fill:"none",stroke:"white",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"1",d:"M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2"})])])])],-1),r=n(`<p>Redis MQ works by listening for messages published to the central <code>mq:topic:in</code> Redis Channel and processes any messages sent in separate background threads which are started from inside your AppHost when calling <code>RedisMqServer.Start()</code>.</p><p>For duplex communication each client and server will require its own AppHost + RedisMqServer Host, although unless your server is going to call HTTP services on the client you can use a <a href="https://github.com/ServiceStack/ServiceStack/blob/master/src/ServiceStack/Testing/BasicAppHost.cs" target="_blank" rel="noopener noreferrer">BasicAppHost</a>.</p><p>Here is a simple example of a client/server with HTTP + RedisMQ enabled on the server, and just RedisMQ on the client:</p><h4 id="shared-cs" tabindex="-1">Shared.cs <a class="header-anchor" href="#shared-cs" aria-hidden="true">#</a></h4><div class="language-csharp"><pre><code><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">TestMqShared</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Hello</span> <span class="token punctuation">{</span> 
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Name <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloResponse</span> <span class="token punctuation">{</span> 
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Result <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="server-cs" tabindex="-1">Server.cs <a class="header-anchor" href="#server-cs" aria-hidden="true">#</a></h4><div class="language-csharp"><pre><code><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Funq</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">ServiceStack</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">ServiceStack<span class="token punctuation">.</span>Messaging<span class="token punctuation">.</span>Redis</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">ServiceStack<span class="token punctuation">.</span>Redis</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">ServiceStack<span class="token punctuation">.</span>Testing</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">TestMqShared</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">TestMq</span>
<span class="token punctuation">{</span>
    <span class="token comment">//Server</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloService</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Service</span></span> 
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">object</span></span> <span class="token function">Any</span><span class="token punctuation">(</span><span class="token class-name">Hello</span> req<span class="token punctuation">)</span> 
        <span class="token punctuation">{</span> 
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">HelloResponse</span> <span class="token punctuation">{</span> Result <span class="token operator">=</span> <span class="token string">&quot;Hello, &quot;</span> <span class="token operator">+</span> req<span class="token punctuation">.</span>Name <span class="token punctuation">}</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServerAppHost</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">AppHostHttpListenerBase</span></span> 
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token function">ServerAppHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span><span class="token string">&quot;Test Server&quot;</span><span class="token punctuation">,</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">HelloService</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Assembly<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Configure</span><span class="token punctuation">(</span><span class="token class-name">Container</span> container<span class="token punctuation">)</span> 
        <span class="token punctuation">{</span>
            <span class="token keyword">base</span><span class="token punctuation">.</span>Routes
                <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Add</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Hello<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">&quot;/hello&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Add</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Hello<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">&quot;/hello/{Name}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name"><span class="token keyword">var</span></span> redisFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">PooledRedisClientManager</span><span class="token punctuation">(</span><span class="token string">&quot;localhost:6379&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            container<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Register</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IRedisClientsManager<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>redisFactory<span class="token punctuation">)</span><span class="token punctuation">;</span> 
            <span class="token class-name"><span class="token keyword">var</span></span> mqHost <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">RedisMqServer</span><span class="token punctuation">(</span>redisFactory<span class="token punctuation">,</span> <span class="token named-parameter punctuation">retryCount</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//Server - MQ Service Impl:</span>

            <span class="token comment">//Listens for &#39;Hello&#39; messages sent with: mqClient.Publish(new Hello { ... })</span>
            mqHost<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">RegisterHandler</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Hello<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">base</span><span class="token punctuation">.</span>ExecuteMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mqHost<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//Starts listening for messages</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">class</span> <span class="token class-name">MainClass</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> serverAppHost <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ServerAppHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            serverAppHost<span class="token punctuation">.</span><span class="token function">Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
            serverAppHost<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:1400/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;Server running.  Press enter to terminate...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//Prevent server from exiting (when running in ConsoleApp)</span>
            Console<span class="token punctuation">.</span><span class="token function">ReadLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="client-cs" tabindex="-1">Client.cs <a class="header-anchor" href="#client-cs" aria-hidden="true">#</a></h4><div class="language-csharp"><pre><code><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Funq</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">ServiceStack</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">ServiceStack<span class="token punctuation">.</span>Messaging</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">ServiceStack<span class="token punctuation">.</span>Messaging<span class="token punctuation">.</span>Redis</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">ServiceStack<span class="token punctuation">.</span>Redis</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">ServiceStack<span class="token punctuation">.</span>Testing</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">TestMqShared</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">TestMqCli</span>
<span class="token punctuation">{</span>
    <span class="token keyword">class</span> <span class="token class-name">MainClass</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> redisFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">PooledRedisClientManager</span><span class="token punctuation">(</span><span class="token string">&quot;localhost:6379&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> mqServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">RedisMqServer</span><span class="token punctuation">(</span>redisFactory<span class="token punctuation">,</span> <span class="token named-parameter punctuation">retryCount</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//Client - MQ Service Impl:</span>
            <span class="token comment">//Listens for &#39;HelloResponse&#39; returned by the &#39;Hello&#39; Service</span>
            mqServer<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">RegisterHandler</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>HelloResponse<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>m <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>  
                Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;Received: &quot;</span> <span class="token operator">+</span> m<span class="token punctuation">.</span><span class="token function">GetBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// See comments below</span>
                <span class="token comment">// m.Options = (int)MessageOption.None;</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//or to call an existing service with:</span>
            <span class="token comment">//mqServer.RegisterHandler&lt;HelloResponse&gt;(m =&gt;   </span>
            <span class="token comment">//    this.ServiceController.ExecuteMessage(m));</span>

            mqServer<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//Starts listening for messages</span>

            <span class="token class-name"><span class="token keyword">var</span></span> mqClient <span class="token operator">=</span> mqServer<span class="token punctuation">.</span><span class="token function">CreateMessageQueueClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mqClient<span class="token punctuation">.</span><span class="token function">Publish</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Hello</span> <span class="token punctuation">{</span> Name <span class="token operator">=</span> <span class="token string">&quot;Client 1&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;Client running.  Press any key to terminate...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">ReadLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//Prevent self-hosted Console App from exiting</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The first RedisMQ host listening to the <code>Hello</code> message (i.e. the server) will process the message.</p><p>When the server returns a &#39;HelloResponse&#39; message it gets put on the &#39;HelloResponse&#39; Inbox Queue and the first RedisMQ Host listening to the &#39;HelloResponse&#39; message (i.e. Client) will have their callback fired.</p><p>Note that the <code>HelloResponse</code> will get put back on a &#39;transient&#39; message queue, <code>mq.HelloResponse.outq</code> with a maximum message limit of 100 (by default). You can subscribe to this queue to get a notification and do further processing, such as recording the number of messages handled. Or you can clear the message <code>NotifyOneWay</code> option to prevent this.</p><h3 id="redismq-client" tabindex="-1">RedisMQ Client <a class="header-anchor" href="#redismq-client" aria-hidden="true">#</a></h3><p>Clients can use a <code>RedisMessageProducer</code> to be able to publish a message, e.g:</p><div class="language-csharp"><pre><code><span class="token class-name"><span class="token keyword">var</span></span> redisManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">RedisManagerPool</span><span class="token punctuation">(</span><span class="token string">&quot;localhost:6379&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> mqClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">RedisMessageProducer</span><span class="token punctuation">(</span>redisManager<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    mqClient<span class="token punctuation">.</span><span class="token function">Publish</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Hello</span> <span class="token punctuation">{</span> Name <span class="token operator">=</span> <span class="token string">&quot;Client 1&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Or if preferred can instead use a <code>RedisMessageFactory</code> which provide access to both <a href="https://github.com/ServiceStack/ServiceStack/blob/master/src/ServiceStack.Interfaces/Messaging/IMessageQueueClient.cs" target="_blank" rel="noopener noreferrer">IMessageQueueClient</a> and <a href="https://github.com/ServiceStack/ServiceStack/blob/master/src/ServiceStack.Interfaces/Messaging/IMessageProducer.cs" target="_blank" rel="noopener noreferrer">IMessageProducer</a>:</p><div class="language-csharp"><pre><code><span class="token class-name">IMessageFactory</span> redisMqFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">RedisMessageFactory</span><span class="token punctuation">(</span>redisManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> mqClient <span class="token operator">=</span> redisMqFactory<span class="token punctuation">.</span><span class="token function">CreateMessageQueueClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    mqClient<span class="token punctuation">.</span><span class="token function">Publish</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Hello</span> <span class="token punctuation">{</span> Name <span class="token operator">=</span> <span class="token string">&quot;Client 1&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="request-reply-mq-pattern" tabindex="-1">Request + Reply MQ Pattern <a class="header-anchor" href="#request-reply-mq-pattern" aria-hidden="true">#</a></h3><p>However MQ&#39;s are normally used for async OneWay messages as any client host listening to &#39;HelloResponse&#39; could receive the response message, and only 1 will, which is not guaranteed to be the client that sent the original message. For this reason you want to make use of the ReplyTo field of the Message for Request/Reply responses.</p><div class="language-csharp"><pre><code><span class="token class-name"><span class="token keyword">var</span></span> uniqueCallbackQ <span class="token operator">=</span> <span class="token string">&quot;mq:c1&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> Guid<span class="token punctuation">.</span><span class="token function">NewGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token string">&quot;N&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name"><span class="token keyword">var</span></span> clientMsg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Message<span class="token punctuation">&lt;</span>Hello<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Hello</span> <span class="token punctuation">{</span> Name <span class="token operator">=</span> <span class="token string">&quot;Client 1&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   ReplyTo <span class="token operator">=</span>  uniqueCallbackQ
<span class="token punctuation">}</span><span class="token punctuation">;</span>
mqClient<span class="token punctuation">.</span><span class="token function">Publish</span><span class="token punctuation">(</span> clientMsg <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//Blocks thread on client until reply message is received</span>
<span class="token class-name"><span class="token keyword">var</span></span> response <span class="token operator">=</span> mqClient<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>clientMsg<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token generic-method"><span class="token function">ToMessage</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>HelloResponse<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
</code></pre></div><p>Note: The ReplyTo callback url could also be a ServiceStack endpoint that expects a &#39;HelloResponse&#39; e.g.</p><div class="language-csharp"><pre><code><span class="token class-name"><span class="token keyword">var</span></span> clientMsg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Message<span class="token punctuation">&lt;</span>Hello<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Hello</span> <span class="token punctuation">{</span> Name <span class="token operator">=</span> <span class="token string">&quot;Client 1&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   ReplyTo <span class="token operator">=</span>  <span class="token string">&quot;http://clienthost:82/helloresponse&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>In this case the server wont put the response message on the back on the MQ and will instead send the response directly to your client web service host.</p><p>There&#39;s a few MQ concepts covered above here, I invite you to do your own reading on MQ&#39;s in general as it works a little different to normal request/reply web services.</p><p>See Also: <a href="http://masonoise.files.wordpress.com/2010/03/redis-cheatsheet-v1.pdf" target="_blank" rel="noopener noreferrer">Redis Commands (PDF)</a></p>`,25),k=[c,l,i,u,r];function d(h,g,m,v,y,w){return p(),t("div",null,k)}var q=e(o,[["render",d]]);export{b as __pageData,q as default};
