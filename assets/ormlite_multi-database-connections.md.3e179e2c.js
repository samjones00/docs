import{_ as n,c as s,o as a,a as t}from"./app.da189b1e.js";const b='{"title":"Multi-nested database connections example","description":"","frontmatter":{"title":"Multi-nested database connections example"},"headers":[{"level":2,"title":"Primary DB & Multi Shard DB Example","slug":"primary-db-multi-shard-db-example"},{"level":3,"title":"Sharding 1000 Robots into 10 Sqlite DB shards","slug":"sharding-1000-robots-into-10-sqlite-db-shards"}],"relativePath":"ormlite/multi-database-connections.md","lastUpdated":1650016416720}',p={},o=t(`<p>The <code>OrmLiteConnectionFactory</code> class supports registering multiple named connections allows you to define all your db connections when registering it in your IOC, that can be accessed later using its registered name.</p><h2 id="primary-db-multi-shard-db-example" tabindex="-1">Primary DB &amp; Multi Shard DB Example <a class="header-anchor" href="#primary-db-multi-shard-db-example" aria-hidden="true">#</a></h2><p>A popular way of scaling RDBMS&#39;s is to create a Master / Shard setup where datasets for queries that span entire system are kept in the master database, whilst context-specific related data can be kept together in an isolated shard. This feature makes it trivial to maintain multiple separate db shards with a master database in a different RDBMS.</p><p>Here&#39;s an (entire source code) sample of the code needed to define, and populate a Master/Shard setup. Sqlite can create DB shards on the fly so only the blank SqlServer master database needed to be created out-of-band:</p><h3 id="sharding-1000-robots-into-10-sqlite-db-shards" tabindex="-1">Sharding 1000 Robots into 10 Sqlite DB shards <a class="header-anchor" href="#sharding-1000-robots-into-10-sqlite-db-shards" aria-hidden="true">#</a></h3><div class="language-csharp"><pre><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MasterRecord</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Guid</span> Id <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> RobotId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> RobotName <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">DateTime<span class="token punctuation">?</span></span> LastActivated <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Robot</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> Id <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Name <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> IsActivated <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">long</span></span> CellCount <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">DateTime</span> CreatedDate <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token class-name"><span class="token keyword">int</span></span> NoOfShards <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token class-name"><span class="token keyword">int</span></span> NoOfRobots <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>

<span class="token class-name"><span class="token keyword">var</span></span> dbFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">OrmLiteConnectionFactory</span><span class="token punctuation">(</span>
    <span class="token string">&quot;Data Source=host;Initial Catalog=RobotsMaster;Integrated Security=SSPI&quot;</span><span class="token punctuation">,</span>  <span class="token comment">//Connection String</span>
    SqlServerDialect<span class="token punctuation">.</span>Provider<span class="token punctuation">)</span><span class="token punctuation">;</span> 

dbFactory<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>db <span class="token operator">=&gt;</span> db<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">CreateTable</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>MasterRecord<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token named-parameter punctuation">overwrite</span><span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

NoOfShards<span class="token punctuation">.</span><span class="token function">Times</span><span class="token punctuation">(</span>i <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> namedShard <span class="token operator">=</span> <span class="token string">&quot;robots-shard&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">;</span>
    dbFactory<span class="token punctuation">.</span><span class="token function">RegisterConnection</span><span class="token punctuation">(</span>namedShard<span class="token punctuation">,</span> 
        <span class="token interpolation-string"><span class="token string">$&quot;~/App_Data/</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">shardId</span><span class="token punctuation">}</span></span><span class="token string">.sqlite&quot;</span></span><span class="token punctuation">.</span><span class="token function">MapAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token comment">//Connection String</span>
        SqliteDialect<span class="token punctuation">.</span>Provider<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	dbFactory<span class="token punctuation">.</span><span class="token function">OpenDbConnection</span><span class="token punctuation">(</span>namedShard<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>db <span class="token operator">=&gt;</span> db<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">CreateTable</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Robot<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token named-parameter punctuation">overwrite</span><span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name"><span class="token keyword">var</span></span> newRobots <span class="token operator">=</span> NoOfRobots<span class="token punctuation">.</span><span class="token function">Times</span><span class="token punctuation">(</span>i <span class="token operator">=&gt;</span> <span class="token comment">//Create 1000 Robots</span>
    <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Robot</span> <span class="token punctuation">{</span> Id<span class="token operator">=</span>i<span class="token punctuation">,</span> Name<span class="token operator">=</span><span class="token string">&quot;R2D&quot;</span><span class="token operator">+</span>i<span class="token punctuation">,</span> CreatedDate<span class="token operator">=</span>DateTime<span class="token punctuation">.</span>UtcNow<span class="token punctuation">,</span> CellCount<span class="token operator">=</span>DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">.</span><span class="token function">ToUnixTimeMs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">100000</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> newRobot <span class="token keyword">in</span> newRobots<span class="token punctuation">)</span> 
<span class="token punctuation">{</span>
    <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name">IDbConnection</span> db <span class="token operator">=</span> dbFactory<span class="token punctuation">.</span><span class="token function">OpenDbConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//Open Connection to Master DB </span>
    <span class="token punctuation">{</span>
        db<span class="token punctuation">.</span><span class="token function">Insert</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">MasterRecord</span> <span class="token punctuation">{</span> Id <span class="token operator">=</span> Guid<span class="token punctuation">.</span><span class="token function">NewGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> RobotId <span class="token operator">=</span> newRobot<span class="token punctuation">.</span>Id<span class="token punctuation">,</span> RobotName <span class="token operator">=</span> newRobot<span class="token punctuation">.</span>Name <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name">IDbConnection</span> robotShard <span class="token operator">=</span> dbFactory<span class="token punctuation">.</span><span class="token function">OpenDbConnection</span><span class="token punctuation">(</span><span class="token string">&quot;robots-shard&quot;</span><span class="token operator">+</span>newRobot<span class="token punctuation">.</span>Id <span class="token operator">%</span> NoOfShards<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//Shard</span>
        <span class="token punctuation">{</span>
            robotShard<span class="token punctuation">.</span><span class="token function">Insert</span><span class="token punctuation">(</span>newRobot<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Using the <a href="https://addons.mozilla.org/en-US/firefox/addon/sqlite-manager/?src=search" target="_blank" rel="noopener noreferrer">SQLite Manager</a> Firefox extension we can peek at one of the created shards to see 100 Robots in each shard. This is the dump of <code>robots-shard0.sqlite</code>:</p><p><img src="https://raw.githubusercontent.com/ServiceStack/docs/master/docs/images/ormlite/robots-shard0.sqlite.jpg" alt="Data dump of Robot Shard #1"></p><p>As expected each shard has every 10th robot inside.</p>`,9),e=[o];function c(l,u,i,r,k,d){return a(),s("div",null,e)}var h=n(p,[["render",c]]);export{b as __pageData,h as default};
